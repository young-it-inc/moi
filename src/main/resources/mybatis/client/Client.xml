<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.youngit.office.api.client.mapper.ClientMapper">

    <!-- 검색 조건 -->
    <sql id="searchClient">
        <if test="searchKey != null and searchKey !=''">
            <choose>
                <when test="searchKey == 'SK01'">
                    and member_id LIKE CONCAT('%', #{searchValue}, '%')
                </when>
                <when test="searchKey == 'SK02'">
                    and name LIKE CONCAT('%', #{searchValue}, '%')
                </when>
                <when test="searchKey == 'SK03'">
                    and telephone LIKE CONCAT('%', #{searchValue}, '%')
                </when>
            </choose>
        </if>

    </sql>

    <!-- 거래처 리스트 조회 및 검색 -->
    <select id="getOrSearchListClient" resultType="ClientModel">
        SELECT *
        FROM o_client
        where is_used = 'Y'
        <include refid="searchClient"/>
    </select>

    <!-- 거래처 리스트 조회 및 검색 카운트 -->
    <select id="countGetOrSearchListClient" resultType="int">
        SELECT COUNT(*)
        FROM o_client
        where is_used = 'Y'
        <include refid="searchClient"/>
    </select>

    <!-- 거래처 개별 조회 -->
    <select id="getOneClient" resultType="ClientModel">
        SELECT *
        FROM o_client
        where is_used = 'Y' and client_uniq_id = #{clientUniqId}
    </select>

    <!-- 거래처 매니저 개별 조회 -->
    <select id="getListClientManager" resultType="ClientManagerModel">
        SELECT *
        FROM o_client_manager
        where client_uniq_id = #{clientUniqId}
    </select>

    <!-- 거래처 등록 -->
    <insert id="registerClient" parameterType="ClientModel">
        INSERT INTO o_client (client_uniq_id, client_type_code, business_registration_number, client_name, representative_name,
                              address, business_type, business_category, phone_number, fax_number,
                              email, item, water_supply_code, bank_name, account_holder,
                              account_number, note, created_at, created_by_member_uniq_id, updated_at,
                              updated_by_member_uniq_id, is_used)
        VALUES (#{clientUniqId}, #{clientTypeCode}, #{businessRegistrationNumber}, #{clientName}, #{representativeName},
                #{address}, #{businessType}, #{businessCategory}, #{phoneNumber}, #{faxNumber},
                #{email}, #{item}, #{waterSupplyCode}, #{bankName}, #{accountHolder},
                #{accountNumber}, #{note}, CURRENT_TIMESTAMP(3), #{createdByMemberUniqId}, CURRENT_TIMESTAMP(3),
                #{updatedByMemberUniqId}, 'Y')
    </insert>

    <!-- 거래처 수정 -->
    <update id="updateClient" parameterType="ClientModel">
        UPDATE o_client
        <set>
            <if test="clientTypeCode != null and clientTypeCode !=''">
                client_type_code = #{clientTypeCode},
            </if>
            <if test="businessRegistrationNumber != null and businessRegistrationNumber !=''">
                business_registration_number = #{businessRegistrationNumber},
            </if>
            <if test="clientName != null and clientName !=''">
                client_name = #{clientName},
            </if>
            <if test="representativeName != null and representativeName !=''">
                representative_name = #{representativeName},
            </if>
            <if test="address != null and address !=''">
                address = #{address},
            </if>
            <if test="businessType != null and businessType !=''">
                business_type = #{businessType},
            </if>
            <if test="businessCategory != null and businessCategory !=''">
                business_category = #{businessCategory},
            </if>
            <if test="phoneNumber != null and phoneNumber !=''">
                phone_number = #{phoneNumber},
            </if>
            <if test="faxNumber != null and faxNumber !=''">
                fax_number = #{faxNumber},
            </if>
            <if test="email != null and email !=''">
                email = #{email},
            </if>
            <if test="item != null and item !=''">
                item = #{item},
            </if>
            <if test="waterSupplyCode != null and waterSupplyCode !=''">
                water_supply_code = #{waterSupplyCode},
            </if>
            <if test="bankName != null and bankName !=''">
                bank_name = #{bankName},
            </if>
            <if test="accountHolder != null and accountHolder !=''">
                account_holder = #{accountHolder},
            </if>
            <if test="accountNumber != null and accountNumber !=''">
                account_number = #{accountNumber},
            </if>
            <if test="note != null and note !=''">
                note = #{note},
            </if>
            <if test="updatedByMemberUniqId != null and updatedByMemberUniqId !=''">
                updated_by_member_uniq_id = #{updatedByMemberUniqId},
            </if>
            updated_at = CURRENT_TIMESTAMP(3)
        </set>
        where is_used = 'Y' and client_uniq_id = #{clientUniqId}
    </update>

    <!-- 거래처 매니저 등록 -->
    <insert id="registerClientManager" parameterType="ClientManagerModel">
        INSERT INTO o_client_manager (client_uniq_id, manager_order, manager_name, manager_department, manager_position, manager_phone_number, manager_email)
        VALUES (#{clientUniqId}, #{managerOrder}, #{managerName}, #{managerDepartment}, #{managerPosition}, #{managerPhoneNumber}, #{managerEmail})
    </insert>

    <!-- 거래처 매니저 삭제 -->
    <delete id="deleteClientManager" parameterType="String"> -- 수정시 삭제 후 재등록 (정작 삭제시엔 삭제x)
        DELETE FROM o_client_manager
        WHERE client_uniq_id = #{clientUniqId}
    </delete>

    <!-- 거래처 삭제 -->
    <update id="deleteClient" parameterType="String"> --delete지만 실제로 삭제는 x, is_used를 N으로 변경
    UPDATE o_client
    set is_used = 'N'
    WHERE client_uniq_id = #{clientUniqId}
    </update>

    <!-- 최근 거래처 고유ID 조회 -->
    <select id="getLastClientUniqId" resultType="String">
        SELECT MAX(client_uniq_id)
        FROM o_client
    </select>

    <!-- 사업자번호 중복 체크 -->
    <select id="checkBizNumber" parameterType="String" resultType="boolean">
        select count(*)>0
        from o_client
        where business_registration_number = #{businessRegistrationNumber} and is_used = 'Y'
    </select>

</mapper>