<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.youngit.office.api.estimate.mapper.EstimateMapper">

    <!-- 검색 조건 -->
    <sql id="searchEstimate">
    </sql>

    <!-- 견적서 리스트 조회 및 검색 -->
    <select id="getOrSearchListEstimate" resultType="EstimateModel">
        SELECT *
        FROM o_estimate
        where is_used = 'Y'
        ORDER BY estimate_uniq_no DESC
    </select>

    <!-- 견적서 리스트 조회 및 검색 카운트 -->
    <select id="countGetOrSearchListEstimate" resultType="int">
        SELECT COUNT(*)
        FROM o_estimate
        where is_used = 'Y'
    </select>

    <!-- 견적서 개별 조회 -->
    <select id="getOneEstimate" resultType="EstimateModel">
        SELECT *
        FROM o_estimate
        WHERE estimate_uniq_no = #{estimate_uniq_no}
    </select>

    <!-- 견적 제품 리스트 조회 -->
    <select id="getEstimateProductList" resultType="EstimateProductModel">
        SELECT *
        FROM o_estimate_product
        WHERE estimate_uniq_no = #{estimateUniqNo}
    </select>

    <!-- 최근 견적 고유번호 조회 -->
    <select id="getLastEstimateUniqNo" resultType="String">
        SELECT MAX(estimate_uniq_no)
        FROM o_estimate
        where estimate_uniq_no like CONCAT(#{todayDate}, '%')
    </select>

    <!-- 견적서 등록 -->
    <insert id="registerEstimate" parameterType="EstimateModel">
insert into o_estimate (estimate_uniq_no, client_name, estimate_main,
                        estimate_main_etc, estimate_name, estimate_method, estimate_code, estimate_quantity,
                        estimate_date, estimate_amount, contract_uniq_no, estimate_note, created_at,
                        created_by_member_uniq_id, updated_at, updated_by_member_uniq_id, is_used)
values (#{estimateUniqNo}, #{clientName}, #{estimateMain},
        #{estimateMainEtc}, #{estimateName}, #{estimateMethod}, #{estimateCode}, #{estimateQuantity},
        #{estimateDate}, #{estimateAmount}, #{contractUniqNo}, #{estimateNote}, CURRENT_TIMESTAMP(3),
        #{createdByUserId}, CURRENT_TIMESTAMP(3), #{updatedByUserId}, 'Y')
    </insert>

    <!-- 견적서 수정 -->
    <update id="updateEstimate" parameterType="EstimateModel">
        UPDATE o_estimate
        SET
            <if test="client_name != null and client_name !=''">
                client_name = #{clientName},
            </if>
        <if test="estimate_main != null and estimate_main !=''">
            estimate_main = #{estimateMain},
        </if>
        <if test="estimate_main_etc != null and estimate_main_etc !=''">
            estimate_main_etc = #{estimateMainEtc},
        </if>
        <if test="estimate_name != null and estimate_name !=''">
            estimate_name = #{estimateName}
        </if>

    WHERE
        estimate_uniq_no = #{estimateUniqNo}
    </update>

    <!-- 견적서 삭제 (사실상 수정) -->
    <delete id="deleteEstimate" parameterType="String">
        UPDATE o_estimate
        SET is_used = 'N'
        WHERE estimate_uniq_no = #{estimateUniqNo}
    </delete>

</mapper>